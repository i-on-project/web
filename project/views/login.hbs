<br><div id="showAllMethods" class="row justify-content-center">
	
    <div class="col-md-4">
		<h2 class="text-center">Métodos de autenticação</h2><br>
		
		<div class="divSpacing">
			{{#each this.data}}
					<!--<a class="button" onclick=showSpecifiedMethod('{{this.type}}')>{{this.type}}</a>-->
					<a class="btn btn-outline-dark btn-lg" role="button" onclick=showSpecifiedMethod('{{this.type}}') id="{{this.type}}button"></a>
			{{/each}}
		</div>
    </div>
</div>

<script>
	/// Specific presentation for email authentication method
	const email = document.querySelector("#emailbutton");			
	email.innerHTML += '<i class="fa fa-envelope-o" aria-hidden="true"></i>  Email Institucional';

	/// If necessary, more presentations for authentication methods can be added here ...

	function showSpecifiedMethod(type) {
        $('#showAllMethods').hide();
        $(`#${type}`).show();
    }

    function back(type) {
        $('#showAllMethods').show();
        $(`#${type}`).hide();
    }

</script>

<div id="email" class="row justify-content-center" style="display:none">

    <div class="col-md-4">

        <h2 class="text-center">Iniciar sessão</h2><br>

        <form id="submitedEmail">

            <!-- Email -->
            <div class="form-group">
                <label class="col-form-labels">Email institucional:</label>
                <input type="text" class="form-control" id="emailValue">
                <p>Domínios disponíveis: </p>
            </div>

            <!-- Submit button -->
            <div class="form-group">
                <button type="submit" class="form-control btn btn-dark" id="submit-button" onclick="submitFunction()">Iniciar sessão</button>
            </div>

            <!-- Back button -->
           <br><button type="button" onclick=back('email') class="btn btn-outline-dark" ><i class="fa fa-angle-double-left" aria-hidden="true"></i> Voltar às opções de autenticação</button>
            <!-- Div that will contain loading icon -->
            <div id="loading"></div>

        </form>
        
    </div>

    <!-- Script to submit email to web-auth-aou and polling -->
	<script>
		async function submitFunction() {
			console.log("12")
			// Deactivate button
			const button = document.querySelector('#submit-button');
			button.disabled = true;

			// Notificate the user that authentication is in progress
			const loading = document.querySelector("#loading");
			
			loading.innerHTML += 
			' <br><br> ' + 
			' <div class="row justify-content-center"> ' + 
				'<div class="divSpacing lds-roller" role="status"><div></div><div></div><div></div><div>' +
			'</div>'

			// Request to auth api to obtain auth_req_id and expiration
			const data = {
				'email' : document.querySelector('#emailValue').value
			};

			console.log("13" + JSON.stringify(data));
			const response = await fetch("/auth-api/email", {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data),
			});
			
			console.log("130");
			
			const authData = await response.json();
			
			console.log("131");
			
			const auth_req_id = authData.auth_req_id;
			let counter = authData.expires_in;

			const polling_uri = `/auth-api/${auth_req_id}/poll`

			// Polling loop
			console.log('-->' + auth_req_id)
			const pollingLoop = setInterval(async () => {
				console.log('counter' + counter)
				counter-=5;

				const pollingResponse = await fetch(polling_uri, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					}
				});
				console.log('response:' + pollingResponse.status);
				if(pollingResponse.status === 200) {
					
					clearInterval(pollingLoop);

					setTimeout(async () => {
						loading.innerHTML = "<p>Autenticação realizada com sucesso!</p>"
						window.location.replace('/');
					}, 1000)
					
				}

				if (counter === 0) {
					loading.innerHTML = "<p>Tempo para autenticação excedido!</p>"
					clearInterval(pollingLoop);
				}

			}, 5000); // TO DO

		}
	</script>

</div>

